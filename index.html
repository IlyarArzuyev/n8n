<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>n8n DataTable Viewer</title>
  <style>
    body { 
      background: #0e0e0e; 
      color: #fff; 
      font-family: sans-serif; 
      padding: 20px; 
      margin: 0;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h2 { margin-bottom: 20px; color: #007bff; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button { padding: 8px 12px; background: #007bff; border: none; color: #fff; cursor: pointer; border-radius: 4px; transition: background 0.3s; }
    button:hover { background: #0056b3; }
    button.delete { background: #dc3545; }
    button.delete:hover { background: #c82333; }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 20px; 
      background: #1a1a1a;
      table-layout: auto; /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —à–∏—Ä–∏–Ω–∞ */
    }
    th, td { 
      border: 1px solid #444; 
      padding: 8px; 
      text-align: left;
      vertical-align: top; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ –≤–µ—Ä—Ö–Ω–µ–º—É –∫—Ä–∞—é */
      white-space: normal; /* –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫ */
      word-break: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å–∏–º –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ */
    }
    th { background: #2d2d2d; font-weight: bold; }
    input { 
      width: 100%; 
      min-height: 24px;
      background: transparent;
      border: none;
      color: #fff;
      padding: 4px;
      border-radius: 3px;
      resize: none;
      font: inherit;
      outline: none;
      overflow: hidden; /* —Å–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª */
    }
    input:focus { background: #222; border: 1px solid #555; }
    .status { padding: 10px; border-radius: 4px; margin-bottom: 15px; display: none; }
    .status.success { background: #155724; color: #d4edda; border: 1px solid #c3e6cb; }
    .status.error { background: #721c24; color: #f8d7da; border: 1px solid #f5c6cb; }
    .loading { text-align: center; padding: 20px; display: none; }
    .search-box { flex-grow: 1; padding: 8px; background: #222; border: 1px solid #555; color: #fff; border-radius: 4px; }
    .actions-cell { white-space: nowrap; text-align: center; }
    tr:hover { background-color: #2a2a2a; }
  </style>
</head>
<body>
  <div class="container">
    <h2>–¢–∞–±–ª–∏—Ü–∞ Data Table (n8n)</h2>
    
    <div class="controls">
      <button onclick="addRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
      <button onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <input type="text" id="searchInput" class="search-box" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable()">
    </div>
    
    <div id="statusMessage" class="status"></div>
    <div id="loadingIndicator" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <table id="table"></table>
  </div>

<script>
const API_BASE   = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c4";
const API_GET    = `${API_BASE}?action=get`;
const API_ADD    = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c44";
const API_UPDATE = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c44";
const API_DELETE = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c44";

let allData = [];

async function loadData() {
  showLoading(true);
  try {
    const response = await fetch(API_GET);
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    const data = await response.json();
    allData = data;
    renderTable(data);
    showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
  } catch (error) {
    console.error(error);
    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

function renderTable(data) {
  const table = document.getElementById("table");

  if (!data || data.length === 0) {
    table.innerHTML = "<tr><td colspan='100%' style='text-align: center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>";
    return;
  }

  const headers = Object.keys(data[0]);
  let tableHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>";

  data.forEach(row => {
    let rowHTML = "<tr>";
    headers.forEach(k => {
      const value = row[k] ? String(row[k]) : '';
      rowHTML += `
        <td>
          <input 
            data-id="${row.id}" 
            data-field="${k}" 
            value="${value.replace(/"/g, '&quot;')}" 
            oninput="autoResize(this)"
          >
        </td>`;
    });
    rowHTML += `
      <td class="actions-cell">
        <button onclick="saveRow('${row.id}')">üíæ</button>
        <button class="delete" onclick="deleteRow('${row.id}')">üóëÔ∏è</button>
      </td>
    </tr>`;
    tableHTML += rowHTML;
  });
  table.innerHTML = tableHTML;

  // –ø–æ–¥–≥–æ–Ω—è–µ–º –≤—ã—Å–æ—Ç—É –≤—Å–µ—Ö input –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç
  document.querySelectorAll("input").forEach(autoResize);
}

function autoResize(input) {
  input.style.height = 'auto';
  input.style.height = (input.scrollHeight) + 'px';
}

async function saveRow(id) {
  const inputs = [...document.querySelectorAll(`input[data-id='${id}']`)];
  const body = {};
  inputs.forEach(i => body[i.dataset.field] = i.value);

  const isNew = !id;
  const endpoint = isNew ? API_ADD : API_UPDATE;
  const action = isNew ? "insert" : "update";

  try {
    const response = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, data: body })
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    showStatus(isNew ? '–°—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

async function addRow() {
  try {
    const response = await fetch(API_ADD, { 
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "insert", data: {} })
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    showStatus('–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏:', error);
    showStatus('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏: ' + error.message, 'error');
  }
}

async function deleteRow(id) {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É?')) return;
  
  try {
    const response = await fetch(API_DELETE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "delete", id })
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    showStatus('–°—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
    showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

function filterTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (!searchTerm) {
    renderTable(allData);
    return;
  }
  const filteredData = allData.filter(row => {
    return Object.values(row).some(value => 
      String(value).toLowerCase().includes(searchTerm)
    );
  });
  renderTable(filteredData);
}

function showStatus(message, type) {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = message;
  statusEl.className = `status ${type}`;
  statusEl.style.display = 'block';
  setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
}

function showLoading(show) {
  document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
loadData();
</script>
</body>
</html>
