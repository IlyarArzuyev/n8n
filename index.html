<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>n8n DataTable Viewer</title>
  <style>
    body { 
      background: #0e0e0e; 
      color: #fff; 
      font-family: sans-serif; 
      padding: 20px; 
      margin: 0;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h2 { margin-bottom: 20px; color: #007bff; }
    .controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button { padding: 8px 12px; background: #007bff; border: none; color: #fff; cursor: pointer; border-radius: 4px; transition: background 0.3s; }
    button:hover { background: #0056b3; }
    button.delete { background: #dc3545; }
    button.delete:hover { background: #c82333; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #1a1a1a; }
    th, td { border: 1px solid #444; padding: 8px; text-align: left; }
    th { background: #2d2d2d; font-weight: bold; }
    input { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 6px; border-radius: 3px; }
    .status { padding: 10px; border-radius: 4px; margin-bottom: 15px; display: none; }
    .status.success { background: #155724; color: #d4edda; border: 1px solid #c3e6cb; }
    .status.error { background: #721c24; color: #f8d7da; border: 1px solid #f5c6cb; }
    .loading { text-align: center; padding: 20px; display: none; }
    .search-box { flex-grow: 1; padding: 8px; background: #222; border: 1px solid #555; color: #fff; border-radius: 4px; }
    .actions-cell { white-space: nowrap; }
    tr:hover { background-color: #2a2a2a; }
  </style>
</head>
<body>
  <div class="container">
    <h2>–¢–∞–±–ª–∏—Ü–∞ Data Table (n8n)</h2>
    
    <div class="controls">
      <button onclick="addRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
      <button onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <input type="text" id="searchInput" class="search-box" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable()">
    </div>
    
    <div id="statusMessage" class="status"></div>
    <div id="loadingIndicator" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <table id="table"></table>
  </div>

<script>
const API_BASE = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c4";
const API_GET = `${API_BASE}?action=get`;
const API_WRITE = API_BASE; // –æ–¥–∏–Ω –≤–µ–±—Ö—É–∫ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

let allData = [];

async function loadData() {
  showLoading(true);
  try {
    const response = await fetch(API_GET);
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    const data = await response.json();
    allData = data;
    renderTable(data);
    showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
  } catch (error) {
    console.error(error);
    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

function renderTable(data) {
  const table = document.getElementById("table");

  if (!data || data.length === 0) {
    table.innerHTML = "<tr><td colspan='100%' style='text-align: center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>";
    return;
  }

  const headers = Object.keys(data[0]);
  let tableHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>";

  data.forEach(row => {
    let rowHTML = "<tr>";
    headers.forEach(k => {
      const value = row[k] ? String(row[k]).replace(/"/g, '&quot;') : '';
      rowHTML += `<td><input data-id="${row.id}" data-field="${k}" value="${value}"></td>`;
    });
    rowHTML += `
      <td class="actions-cell">
        <button onclick="saveRow('${row.id}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="delete" onclick="deleteRow('${row.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
      </td>
    </tr>`;
    tableHTML += rowHTML;
  });
  table.innerHTML = tableHTML;
}

async function saveRow(id) {
  const inputs = [...document.querySelectorAll(`input[data-id='${id}']`)];
  const body = {};
  inputs.forEach(i => body[i.dataset.field] = i.value);

  // –ï—Å–ª–∏ –Ω–µ—Ç id ‚Üí —ç—Ç–æ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
  const action = id ? "update" : "insert";

  try {
    const response = await fetch(API_WRITE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, data: body })
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    showStatus(action === "insert" ? '–°—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

async function addRow() {
  try {
    const response = await fetch(API_WRITE, { 
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "insert", data: {} })
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    showStatus('–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏:', error);
    showStatus('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏: ' + error.message, 'error');
  }
}

async function deleteRow(id) {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É?')) return;
  
  try {
    const response = await fetch(API_WRITE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "delete", id })
    });
    
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    showStatus('–°—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
    showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

function filterTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (!searchTerm) {
    renderTable(allData);
    return;
  }
  const filteredData = allData.filter(row => {
    return Object.values(row).some(value => 
      String(value).toLowerCase().includes(searchTerm)
    );
  });
  renderTable(filteredData);
}

function showStatus(message, type) {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = message;
  statusEl.className = `status ${type}`;
  statusEl.style.display = 'block';
  setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
}

function showLoading(show) {
  document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
loadData();
</script>
</body>
</html>
