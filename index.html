<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>n8n DataTable Viewer</title>
  <style>
    body { 
      background: #0e0e0e; 
      color: #fff; 
      font-family: sans-serif; 
      padding: 0; 
      margin: 0;
    }
    .container { 
      width: 100%;
      max-width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
    h2 { 
      margin-bottom: 20px; 
      color: #007bff; 
      font-size: 22px;
    }
    .controls { 
      margin-bottom: 20px; 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      align-items: center; 
    }
    button { 
      padding: 8px 12px; 
      background: #007bff; 
      border: none; 
      color: #fff; 
      cursor: pointer; 
      border-radius: 4px; 
      transition: background 0.3s; 
      white-space: nowrap;
    }
    button:hover { background: #0056b3; }
    button.delete { background: #dc3545; }
    button.delete:hover { background: #c82333; }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
    .table-container {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
    }

    table { 
      border-collapse: collapse; 
      width: 100%; 
      min-width: 100%;
      background: #1a1a1a;
      word-break: break-word; 
      table-layout: fixed; /* —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã */
    }

    th, td { 
      border: 1px solid #444; 
      padding: 8px; 
      text-align: left;
      vertical-align: top;
      white-space: normal;
      width: auto;
    }
    th { 
      background: #2d2d2d; 
      font-weight: bold; 
      position: sticky;
      top: 0;
      z-index: 2;
    }

    /* –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤–≤–æ–¥ */
    textarea.cell-input {
      width: 100%;
      min-height: 28px;
      max-height: 600px;
      box-sizing: border-box;
      background: transparent;
      border: none;
      color: #fff;
      padding: 4px;
      border-radius: 3px;
      font: inherit;
      outline: none;
      resize: none;
      overflow: hidden;
      white-space: pre-wrap;
      word-break: break-word;
    }
    textarea.cell-input:focus { 
      background: #222; 
      border: 1px solid #555; 
    }

    .status { 
      padding: 10px; 
      border-radius: 4px; 
      margin-bottom: 15px; 
      display: none; 
    }
    .status.success { 
      background: #155724; 
      color: #d4edda; 
      border: 1px solid #c3e6cb; 
    }
    .status.error { 
      background: #721c24; 
      color: #f8d7da; 
      border: 1px solid #f5c6cb; 
    }

    .loading { 
      text-align: center; 
      padding: 20px; 
      display: none; 
    }

    .search-box { 
      flex-grow: 1; 
      padding: 8px; 
      background: #222; 
      border: 1px solid #555; 
      color: #fff; 
      border-radius: 4px; 
    }

    .actions-cell { 
      white-space: nowrap; 
      text-align: center; 
      width: 1%; 
    }

    tr:hover { background-color: #2a2a2a; }

    /* –ê–¥–∞–ø—Ç–∏–≤ */
    @media (max-width: 768px) {
      th, td {
        font-size: 14px;
        padding: 6px;
      }
      button { font-size: 14px; padding: 6px 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>–¢–∞–±–ª–∏—Ü–∞ Data Table (n8n)</h2>
    
    <div class="controls">
      <button onclick="addRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
      <button onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <input type="text" id="searchInput" class="search-box" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable()">
    </div>
    
    <div id="statusMessage" class="status"></div>
    <div id="loadingIndicator" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    
    <div class="table-container">
      <table id="table"></table>
    </div>
  </div>

<script>
const API_BASE   = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c4";
const API_GET    = `${API_BASE}?action=get`;
const API_ADD    = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c44";
const API_UPDATE = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c44";
const API_DELETE = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c44";

let allData = [];

async function loadData() {
  showLoading(true);
  try {
    const response = await fetch(API_GET);
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    const data = await response.json();
    allData = data;
    renderTable(data);
    showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
  } catch (error) {
    console.error(error);
    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function renderTable(data) {
  const table = document.getElementById("table");
  if (!data || data.length === 0) {
    table.innerHTML = "<tr><td colspan='100%' style='text-align: center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>";
    return;
  }

  const headers = Object.keys(data[0]);
  let tableHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join("") + "<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>";

  data.forEach(row => {
    let rowHTML = "<tr>";
    headers.forEach(k => {
      const value = row[k] != null ? String(row[k]) : '';
      rowHTML += `
        <td>
          <textarea class="cell-input" data-id="${escapeHtml(row.id)}" data-field="${escapeHtml(k)}" oninput="autoResize(this)">${escapeHtml(value)}</textarea>
        </td>`;
    });
    rowHTML += `
      <td class="actions-cell">
        <button onclick="saveRow('${escapeHtml(row.id)}')">üíæ</button>
        <button class="delete" onclick="deleteRow('${escapeHtml(row.id)}')">üóëÔ∏è</button>
      </td>
    </tr>`;
    tableHTML += rowHTML;
  });
  table.innerHTML = tableHTML;

  // –ü–æ–¥–≥–æ–Ω–∫–∞ –≤—ã—Å–æ—Ç—ã –≤—Å–µ—Ö textarea
  document.querySelectorAll("textarea.cell-input").forEach(autoResize);
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
}

async function saveRow(id) {
  const inputs = [...document.querySelectorAll(`textarea[data-id='${id}']`)];
  const body = {};
  inputs.forEach(i => body[i.dataset.field] = i.value);

  const isNew = !id;
  const endpoint = isNew ? API_ADD : API_UPDATE;
  const action = isNew ? "insert" : "update";

  try {
    const response = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, data: body })
    });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    showStatus(isNew ? '–°—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞' : '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

async function addRow() {
  try {
    const response = await fetch(API_ADD, { 
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "insert", data: {} })
    });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    showStatus('–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏:', error);
    showStatus('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏: ' + error.message, 'error');
  }
}

async function deleteRow(id) {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É?')) return;
  try {
    const response = await fetch(API_DELETE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "delete", id })
    });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    showStatus('–°—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
    showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

function filterTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (!searchTerm) {
    renderTable(allData);
    return;
  }
  const filteredData = allData.filter(row => {
    return Object.values(row).some(value => 
      String(value).toLowerCase().includes(searchTerm)
    );
  });
  renderTable(filteredData);
}

function showStatus(message, type) {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = message;
  statusEl.className = `status ${type}`;
  statusEl.style.display = 'block';
  setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
}

function showLoading(show) {
  document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

loadData();
</script>
</body>
</html>
