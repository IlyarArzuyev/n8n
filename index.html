<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Sensata datatable</title>
  <style>
    body { 
      background: #0e0e0e; 
      color: #fff; 
      font-family: sans-serif; 
      margin: 0;
    }
    .container { 
      padding: 20px;
      box-sizing: border-box;
    }
    h2 { 
      margin-bottom: 20px; 
      color: #007bff; 
      font-size: 22px;
    }
    .controls { 
      margin-bottom: 20px; 
      display: flex; 
      gap: 10px; 
      flex-wrap: wrap; 
      align-items: center; 
    }
    button { 
      padding: 8px 12px; 
      background: #007bff; 
      border: none; 
      color: #fff; 
      cursor: pointer; 
      border-radius: 4px; 
      transition: background 0.3s; 
    }
    button:hover { background: #0056b3; }
    button.delete { background: #dc3545; }
    button.delete:hover { background: #c82333; }
    button.send { background: #28a745; }
    button.send:hover { background: #218838; }

    .table-container {
      width: 100%;
      overflow-x: auto;
    }

    table { 
      border-collapse: collapse; 
      width: 100%;
      background: #1a1a1a;
      word-break: break-word; 
      table-layout: fixed;
    }

    th, td { 
      border: 1px solid #444; 
      padding: 8px; 
      text-align: left;
      vertical-align: top;
      white-space: normal;
      position: relative;
    }
    th { 
      background: #2d2d2d; 
      font-weight: bold; 
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      user-select: none;
      background: transparent;
    }
    .resizer:hover {
      background: rgba(255,255,255,0.1);
    }

    textarea.cell-input {
      width: 100%;
      min-height: 28px;
      background: transparent;
      border: none;
      color: #fff;
      padding: 4px;
      font: inherit;
      outline: none;
      resize: none;
      overflow: hidden;
    }
    textarea.cell-input:focus { 
      background: #222; 
      border: 1px solid #555; 
    }

    .status { 
      padding: 10px; 
      border-radius: 4px; 
      margin-bottom: 15px; 
      display: none; 
    }
    .status.success { 
      background: #155724; 
      color: #d4edda; 
    }
    .status.error { 
      background: #721c24; 
      color: #f8d7da; 
    }

    .loading { 
      text-align: center; 
      padding: 20px; 
      display: none; 
    }

    .search-box { 
      flex-grow: 1; 
      padding: 8px; 
      background: #222; 
      border: 1px solid #555; 
      color: #fff; 
      border-radius: 4px; 
    }

    .actions-cell { 
      white-space: nowrap; 
      text-align: center; 
      width: 1%; 
    }

    tr:hover { background-color: #2a2a2a; }

    @media (max-width: 768px) {
      th, td {
        font-size: 14px;
        padding: 6px;
      }
      button { font-size: 14px; padding: 6px 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Sensata —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –¥–µ–±–µ—Ç–æ—Ä—Å–∫–æ–π –∑–∞–¥–æ–ª–∂–Ω–æ—Å—Ç–∏ –∂–∏–ª—å—Ü–æ–≤</h2>
    <div class="controls">
      <button onclick="addRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
      <button onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      <button class="send" onclick="sendToWebhook()">üì§ –í–Ω–µ—Å—Ç–∏ –≤ —Ç–∞–±–ª–∏—Ü—É</button>
     <button onclick="window.open('https://docs.google.com/spreadsheets/d/1cPvatKdKBRbnkyidcxJgR_sYUq-nuZiwgFcn69flIhA/edit?gid=333759637#gid=333759637', '_blank')">–û—Ç–∫—Ä—ã—Ç—å —Ç–∞–±–ª–∏—Ü—É üìù</button>
      <input type="text" id="searchInput" class="search-box" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable()">
    </div>
    <div id="statusMessage" class="status"></div>
    <div id="loadingIndicator" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div class="table-container">
      <table id="table"></table>
    </div>
  </div>

<script>
const API_BASE   = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c4";
const API_GET    = `${API_BASE}?action=get`;
const API_ADD    = "https://n8n-n8n.sbifer.easypanel.host/webhook/6232344f-cec4-48c9-aed0-3853c03d52c44";
const API_UPDATE = API_ADD;
const API_DELETE = API_ADD;
const API_SEND   = API_ADD;

let allData = [];

/* --------------------- LOAD DATA --------------------- */
async function loadData() {
  showLoading(true);
  try {
    const response = await fetch(API_GET);
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    const data = await response.json();
    allData = data;
    renderTable(data);
    showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
  } catch (error) {
    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
  } finally {
    showLoading(false);
  }
}

/* --------------------- SEND TO WEBHOOK --------------------- */
async function sendToWebhook() {
  if (!confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É?')) return;
  try {
    const response = await fetch(API_SEND, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(allData)
    });
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    showStatus('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É', 'success');
  } catch (error) {
    showStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
  }
}

/* --------------------- RENDER --------------------- */
function renderTable(data) {
  const table = document.getElementById("table");
  if (!data || data.length === 0) {
    table.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>";
    return;
  }

  const headers = Object.keys(data[0]);
  let tableHTML = "<tr>" + headers.map(h => `<th>${h}<div class='resizer'></div></th>`).join("") + "<th>–î–µ–π—Å—Ç–≤–∏—è<div class='resizer'></div></th></tr>";

  data.forEach(row => {
    let rowHTML = "<tr>";
    headers.forEach(k => {
      const value = row[k] != null ? String(row[k]) : '';
      rowHTML += `<td><textarea class="cell-input" data-id="${escapeHtml(row.id)}" data-field="${escapeHtml(k)}" oninput="autoResize(this)">${escapeHtml(value)}</textarea></td>`;
    });
    rowHTML += `
      <td class="actions-cell">
        <button onclick="saveRow('${escapeHtml(row.id)}')">üíæ</button>
        <button class="delete" onclick="deleteRow('${escapeHtml(row.id)}')">üóëÔ∏è</button>
      </td>`;
    tableHTML += rowHTML;
  });
  table.innerHTML = tableHTML;

  document.querySelectorAll("textarea.cell-input").forEach(autoResize);
  applyResizableColumns();
  restoreColumnWidths();
}

/* --------------------- ADD ROW --------------------- */
async function addRow() {
  try {
    const response = await fetch(API_ADD, { 
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "insert", data: {} })
    });
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    showStatus('–ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    showStatus('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

/* --------------------- SAVE ROW --------------------- */
async function saveRow(id) {
  const inputs = [...document.querySelectorAll(`textarea[data-id='${id}']`)];
  const body = {};
  inputs.forEach(i => body[i.dataset.field] = i.value);
  const endpoint = id ? API_UPDATE : API_ADD;
  const action = id ? "update" : "insert";

  try {
    const response = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, data: body })
    });
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    showStatus(id ? '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã' : '–°—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

/* --------------------- DELETE ROW --------------------- */
async function deleteRow(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É?')) return;
  try {
    const response = await fetch(API_DELETE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "delete", id })
    });
    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
    showStatus('–°—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
    await loadData();
  } catch (error) {
    showStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'error');
  }
}

/* --------------------- RESIZABLE COLUMNS --------------------- */
function applyResizableColumns() {
  const table = document.getElementById('table');
  const ths = table.querySelectorAll('th');

  ths.forEach((th, index) => {
    const resizer = th.querySelector('.resizer');
    if (!resizer) return;

    let startX, startWidth;

    resizer.addEventListener('mousedown', e => {
      startX = e.pageX;
      startWidth = th.offsetWidth;
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', stopResize);
    });

    function resize(e) {
      const newWidth = startWidth + (e.pageX - startX);
      th.style.width = newWidth + 'px';
      saveColumnWidth(index, newWidth);
    }

    function stopResize() {
      document.removeEventListener('mousemove', resize);
      document.removeEventListener('mouseup', stopResize);
    }
  });
}

/* --------------------- SAVE / RESTORE WIDTHS --------------------- */
function saveColumnWidth(index, width) {
  const widths = JSON.parse(localStorage.getItem('tableWidths') || '{}');
  widths[index] = width;
  localStorage.setItem('tableWidths', JSON.stringify(widths));
}

function restoreColumnWidths() {
  const widths = JSON.parse(localStorage.getItem('tableWidths') || '{}');
  const ths = document.querySelectorAll('#table th');
  Object.keys(widths).forEach(i => {
    if (ths[i]) ths[i].style.width = widths[i] + 'px';
  });
}

/* --------------------- HELPERS --------------------- */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
}

function filterTable() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (!searchTerm) { renderTable(allData); return; }
  const filteredData = allData.filter(row => 
    Object.values(row).some(value => String(value).toLowerCase().includes(searchTerm))
  );
  renderTable(filteredData);
}

function showStatus(message, type) {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = message;
  statusEl.className = `status ${type}`;
  statusEl.style.display = 'block';
  setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
}

function showLoading(show) {
  document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

loadData();
</script>
</body>
</html>
